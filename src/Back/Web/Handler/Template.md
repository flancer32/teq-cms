# Fl32_Cms_Back_Web_Handler_Template — правила обработки HTTP-запроса

## Назначение

Этот обработчик отвечает за поиск и рендеринг шаблонов для CMS. Он работает в цепочке других обработчиков и находится до
`Fl32_Web_Back_Handler_Static` (обработчик статического контента из web-плагина). Критерием для обработки запроса
является тот факт, что веб-запрос адресует существующий файл шаблона. Если запросу не соответствует никакой шаблон, то
обработчик игнорирует запрос и передаёт управление дальше (`return false`).

## Формирование адреса шаблона

Шаблоны в CMS могут существовать на разных языках и на разных уровнях (в приложении или в npm-пакетах). При этом в
приложении могут быть переопределены шаблоны пакетов. За поиск нужного шаблона с учётом локалей и переопределений
отвечает сервис `Fl32_Tmpl_Back_Service_File_Find`.


---

## Алгоритм

### 1. Распарсить путь запроса

- Извлечь `urlPath = decodeURIComponent(req.url.split('?')[0])`
- Проверить наличие префикса локали (например, `en`, `fr`) в `urlPath`

### 2. Извлечь локаль пользователя

- Если путь начинается с допустимой локали:
    - `locale = extracted`
    - `cleanPath = остальная часть пути`
- Иначе:
    - `locale = defaultLocale`
    - `cleanPath = urlPath`

### 3. Построить путь к шаблону

- `tmplPath = buildTemplatePath(cleanPath)`  
  (например, `'about/'` → `'about/index.html'`)

### 4. Проверить наличие шаблона

- Вызвать `actTmplFind.find({name: tmplPath, type: 'web', locales: {user: locale, app: defaultLocale}})`
- Если шаблон не найден → `return false`

### 5. Если локаль не указана в URL → сделать редирект

- Сформировать `redirectUrl = '/' + locale + urlPath`
- Вернуть `respond.code302_Found({res, location: redirectUrl})`
- `return true`

### 6. Если локаль указана в URL → выполнить рендеринг

- Вызвать `adapter.getRenderData({req})` → получить `{target, data, options}`
- Вызвать `servTmplRender.perform({target, data, options})`
- Если `content` не пустой:
    - Вернуть `respond.code200_Ok({res, headers, body: content})`
    - `return true`
- Иначе → `return false`

---

## Примечания

- Путь без локали не считается корректным, если шаблон найден — пользователь должен быть перенаправлён.
- Шаблон может находиться как в приложении, так и в плагине (параметр `pkg` может быть пустым).
- Локаль `user` и `app` передаются через DTO `Fl32_Tmpl_Back_Dto_Target`.
